<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Location Tracker + AR</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
    }
    #map { flex: 2; }
    #sidebar {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      border-left: 2px solid #ddd;
    }
    .location-card {
      background: #f9f9f9;
      margin: 8px 0;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .actions button {
      margin: 4px;
    }
    #locationSelect {
      width: 100%;
      padding: 6px;
      margin-bottom: 10px;
    }
    #ar-container {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: black;
      z-index: 1000;
    }
    #exitArBtn {
      position: absolute;
      top: 10px; right: 10px;
      z-index: 1100;
      padding: 10px;
      background: red;
      color: white;
      border: none;
      border-radius: 6px;
    }
  </style>
  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-ar@1.8.0/dist/aframe-ar.min.js"></script>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h3>Locations</h3>
    <select id="locationSelect">
      <option value="">-- Select Location --</option>
    </select>
    <button onclick="openAR()">üåç AR View</button>
    <div id="locationList"></div>
  </div>

  <!-- AR container -->
  <div id="ar-container">
    <button id="exitArBtn" onclick="closeAR()">Exit AR</button>
    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;"
      id="arScene"
    >
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    // Initialize map
    const map = L.map("map").setView([7.5, 125.0], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap contributors"
    }).addTo(map);

    let userMarker;
    let userCoords = null;
    let arObjects = [];

    // Supabase config
    const supabaseUrl = "https://clywxultbpgqlqlorjjh.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNseXd4dWx0YnBncWxxbG9yampoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjAzNzUsImV4cCI6MjA3MTY5NjM3NX0.nAAU2oT9-hy7tekZGsVwNMKzTzZSRCvJWjBEiba8F3U";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Distance calc
    function calcDistance(lat1, lon1, lat2, lon2) {
      function toRad(v) { return v * Math.PI / 180; }
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Display locations
    async function displayLocations() {
      const { data, error } = await supabase.from("locations").select("*");
      if (error) {
        console.error(error);
        return;
      }

      const listDiv = document.getElementById("locationList");
      const select = document.getElementById("locationSelect");
      listDiv.innerHTML = "";
      select.innerHTML = `<option value="">-- Select Location --</option>`;
      arObjects = [];

      data.forEach(loc => {
        // Add sidebar
        let distanceText = "";
        if (userCoords) {
          const dist = calcDistance(userCoords.lat, userCoords.lon, loc.latitude, loc.longitude);
          distanceText = `<br><strong>Distance:</strong> ${dist.toFixed(2)} m`;
        }
        listDiv.innerHTML += `
          <div class="location-card">
            <strong>${loc.name}</strong><br>
            Lat: ${loc.latitude}, Lon: ${loc.longitude}
            ${distanceText}
            <div class="actions">
              <button onclick="viewLocation('${loc.name}', ${loc.latitude}, ${loc.longitude})">View</button>
              <button onclick="editLocation(${loc.id}, '${loc.name}', ${loc.latitude}, ${loc.longitude})">Update</button>
              <button onclick="deleteLocation(${loc.id})">Delete</button>
            </div>
          </div>
        `;

        // Dropdown
        const option = document.createElement("option");
        option.value = JSON.stringify({lat: loc.latitude, lon: loc.longitude, name: loc.name});
        option.textContent = loc.name;
        select.appendChild(option);

        // Marker on map
        L.marker([loc.latitude, loc.longitude]).addTo(map)
          .bindPopup(`<b>${loc.name}</b><br>Lat: ${loc.latitude}, Lon: ${loc.longitude}`);

        // Save for AR
        arObjects.push(loc);
      });
    }

    // Map actions
    function viewLocation(name, lat, lon) {
      map.setView([lat, lon], 16);
      L.popup().setLatLng([lat, lon]).setContent(`<b>${name}</b>`).openOn(map);
    }
    function editLocation(id, name, lat, lon) { alert(`Edit ${name}`); }
    function deleteLocation(id) { alert(`Delete ID: ${id}`); }

    document.getElementById("locationSelect").addEventListener("change", (e) => {
      if (e.target.value) {
        const loc = JSON.parse(e.target.value);
        viewLocation(loc.name, loc.lat, loc.lon);
      }
    });

    // Geolocation
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude } = pos.coords;
        userCoords = { lat: latitude, lon: longitude };
        if (!userMarker) {
          userMarker = L.marker([latitude, longitude]).addTo(map).bindPopup("You are here");
          map.setView([latitude, longitude], 15);
        } else {
          userMarker.setLatLng([latitude, longitude]);
        }
        displayLocations();
      }, err => console.error(err), { enableHighAccuracy: true });
    }

    // Open AR
    function openAR() {
      document.getElementById("ar-container").style.display = "block";
      const scene = document.getElementById("arScene");

      // Remove old objects
      scene.querySelectorAll("a-box").forEach(el => el.remove());

      // Add cubes for each location
      arObjects.forEach(loc => {
        const box = document.createElement("a-box");
        box.setAttribute("gps-entity-place", `latitude: ${loc.latitude}; longitude: ${loc.longitude}`);
        box.setAttribute("color", "tomato");
        box.setAttribute("depth", "2");
        box.setAttribute("height", "2");
        box.setAttribute("width", "2");
        box.setAttribute("animation", "property: rotation; to: 0 360 0; loop: true; dur: 6000");
        scene.appendChild(box);
      });
    }

    // Close AR
    function closeAR() {
      document.getElementById("ar-container").style.display = "none";
    }

    // Initial load
    displayLocations();
  </script>
</body>
</html>
