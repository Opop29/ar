<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Markerless AR Floating Cube</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <!-- AR.js is NOT needed here, we use WebXR -->
  <style>
    body, html { margin: 0; height: 100%; overflow: hidden; }
    .hud {
      position: fixed; bottom: 0; left: 0; right: 0;
      padding: 12px; text-align: center;
      font-family: Arial, sans-serif; font-size: 14px;
      color: white; background: linear-gradient(to top, rgba(0,0,0,.6), rgba(0,0,0,0));
      pointer-events: none;
    }
  </style>
</head>
<body>
  <a-scene
    renderer="antialias: true; physicallyCorrectLights: true"
    xr-mode-ui="enabled: true"
    embedded
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true">

    <!-- AR Camera with hit-test support -->
    <a-camera position="0 1.6 0" look-controls="enabled: false"></a-camera>

    <!-- Reticle shows where cube will be placed -->
    <a-entity id="reticle"
              geometry="primitive: ring; radiusInner: 0.04; radiusOuter: 0.05"
              material="color: yellow; shader: flat"
              position="0 0 -1"
              rotation="-90 0 0"
              visible="false">
    </a-entity>

    <!-- Light -->
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 0.6" position="1 3 2"></a-entity>
  </a-scene>

  <div class="hud">Tap on the surface to place a floating cube âœ¨</div>

  <script>
    // Once scene is loaded
    document.querySelector('a-scene').addEventListener('loaded', () => {
      const scene = document.querySelector('a-scene');
      const reticle = document.getElementById('reticle');
      let hitTestSource = null;
      let localSpace = null;

      scene.renderer.xr.addEventListener('sessionstart', () => {
        const session = scene.renderer.xr.getSession();
        session.requestReferenceSpace('viewer').then(refSpace => {
          session.requestHitTestSource({ space: refSpace }).then(source => {
            hitTestSource = source;
          });
        });
        session.requestReferenceSpace('local').then(refSpace => {
          localSpace = refSpace;
        });
      });

      scene.renderer.xr.addEventListener('sessionend', () => {
        hitTestSource = null;
        localSpace = null;
      });

      scene.renderer.xr.addEventListener('beforexrframe', (e) => {
        if (!hitTestSource || !localSpace) return;

        const frame = e.detail;
        const hitTestResults = frame.getHitTestResults(hitTestSource);

        if (hitTestResults.length > 0) {
          const pose = hitTestResults[0].getPose(localSpace);
          reticle.visible = true;
          reticle.object3D.position.copy(pose.transform.position);
          reticle.object3D.quaternion.copy(pose.transform.orientation);
        } else {
          reticle.visible = false;
        }
      });

      // Tap to place cube
      scene.addEventListener('click', () => {
        if (!reticle.visible) return;

        const cube = document.createElement('a-box');
        cube.setAttribute('position',
          `${reticle.object3D.position.x} ${reticle.object3D.position.y + 0.5} ${reticle.object3D.position.z}`);
        cube.setAttribute('color', '#4CC3D9');
        cube.setAttribute('depth', '0.5');
        cube.setAttribute('height', '0.5');
        cube.setAttribute('width', '0.5');

        // Floating animation
        cube.innerHTML = `
          <a-animation attribute="position" dur="1500"
            from="${reticle.object3D.position.x} ${reticle.object3D.position.y + 0.45} ${reticle.object3D.position.z}"
            to="${reticle.object3D.position.x} ${reticle.object3D.position.y + 0.65} ${reticle.object3D.position.z}"
            direction="alternate" repeat="indefinite" easing="easeInOutSine">
          </a-animation>
        `;

        scene.appendChild(cube);
      });
    });
  </script>
</body>
</html>
