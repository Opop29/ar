<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Navigation HUD</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-gps-camera@1.7.0/dist/aframe-gps-camera.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-gps-entity-place@1.7.0/dist/aframe-gps-entity-place.min.js"></script>
  <style>
    body, html { margin:0; padding:0; overflow:hidden; font-family:Arial,sans-serif; }
    .hud { position:absolute; z-index:9999; color:white; font-size:14px; }
    #etaBox { top:15px; left:15px; background:rgba(0,0,0,0.6); padding:10px; border-radius:8px; }
    #directionBox { top:15px; right:15px; background:rgba(0,0,0,0.6); padding:10px; border-radius:8px; text-align:right; }
    #compass { bottom:15px; right:15px; background:rgba(0,0,0,0.6); width:100px; height:100px; border-radius:50%; display:flex; align-items:center; justify-content:center; }
    #time { bottom:15px; left:15px; background:rgba(0,0,0,0.6); padding:8px; border-radius:6px; }
  </style>
</head>
<body>
  <!-- HUD Panels -->
  <div id="etaBox" class="hud">
    <div>ETA: <span id="eta">--</span></div>
    <div><span id="duration">--</span></div>
  </div>

  <div id="directionBox" class="hud">
    <div><span id="distance">--</span> m</div>
    <div>Turn <span id="turn">--</span> on <b id="street">--</b></div>
  </div>

  <div id="compass" class="hud">ðŸ§­</div>
  <div id="time" class="hud"><span id="clock">--:--</span></div>

  <!-- A-Frame Scene -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false;"
  >
    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <script>
    // Example route (replace with Supabase fetch)
    const route = [
      { lat: 37.7749, lon: -122.4194, name: "Market St", turn: "right" },
      { lat: 37.7755, lon: -122.4180, name: "Smithe St", turn: "left" }
    ];

    const scene = document.querySelector("a-scene");
    let currentIndex = 0;
    let userPos = { lat: null, lon: null };

    // Add arrows for all waypoints
    route.forEach(loc => {
      const arrow = document.createElement("a-entity");
      arrow.setAttribute("gps-entity-place", `latitude: ${loc.lat}; longitude: ${loc.lon}`);
      arrow.setAttribute("gltf-model", "https://cdn.aframe.io/test-models/models/arrow/arrow.gltf");
      arrow.setAttribute("scale", "5 5 5");
      arrow.setAttribute("look-at", "[gps-camera]");
      scene.appendChild(arrow);
    });

    // Distance calculator (Haversine)
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // meters
      const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180;
      const Î”Ï† = (lat2-lat1) * Math.PI/180;
      const Î”Î» = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                Math.cos(Ï†1) * Math.cos(Ï†2) *
                Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Update HUD
    function updateHUD() {
      if (userPos.lat === null) return;

      const target = route[currentIndex];
      const dist = getDistance(userPos.lat, userPos.lon, target.lat, target.lon);

      document.getElementById("distance").textContent = dist.toFixed(1);
      document.getElementById("turn").textContent = target.turn;
      document.getElementById("street").textContent = target.name;

      // Switch to next waypoint if close enough
      if (dist < 10 && currentIndex < route.length-1) {
        currentIndex++;
      }

      // Mock ETA/duration (you can replace with real API like OSRM or Google Maps)
      document.getElementById("eta").textContent = new Date(Date.now() + dist*100).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      document.getElementById("duration").textContent = Math.ceil(dist/80) + " min"; // ~80m/min walking
    }

    // GPS tracking
    navigator.geolocation.watchPosition(pos => {
      userPos.lat = pos.coords.latitude;
      userPos.lon = pos.coords.longitude;
      updateHUD();
    }, err => console.error(err), { enableHighAccuracy:true });

    // Clock updater
    setInterval(() => {
      const now = new Date();
      document.getElementById("clock").textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }, 1000);
  </script>
</body>
</html>
